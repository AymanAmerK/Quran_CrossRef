<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuranViz Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Lateef&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* === VARIABLES & THEME === */
        :root {
            /* Palette */
            --primary: #0f766e; /* Deep Teal */
            --primary-light: #14b8a6;
            --accent: #d97706; /* Gold/Amber */
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --highlight: #f0fdf4; /* Light Green */
            
            /* Typography */
            --font-ui: 'Inter', system-ui, sans-serif;
            --font-quran: 'Lateef', serif; 
            
            /* Dynamic Sizes */
            --quran-size: 32px; 
            --trans-size: calc(var(--quran-size) * 0.55);
        }

        [data-theme="dark"] {
            --primary: #2dd4bf;
            --primary-light: #5eead4;
            --accent: #fbbf24;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --highlight: rgba(45, 212, 191, 0.1);
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            font-family: var(--font-ui); 
            background: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* === HEADER === */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            z-index: 50;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Inputs & Buttons */
        .btn-icon, .form-control {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .form-control:focus { border-color: var(--primary); }
        .btn-icon { cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 40px; }
        .btn-icon:hover { border-color: var(--primary); color: var(--primary); }

        input[type=range] { width: 80px; accent-color: var(--primary); cursor: pointer; }
        .search-wrap { flex: 1; max-width: 400px; }
        #search-input { width: 100%; }

        /* === MAIN LAYOUT === */
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left/Top Panel: Reader */
        #reader-panel {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        /* Right Panel: Context (Desktop) */
        #side-panel {
            width: 380px;
            background: var(--bg-card);
            border-inline-start: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.05);
        }
        
        #side-panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #side-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* === VERSE STYLING === */
        .verse-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
            position: relative;
        }

        .verse-card:hover { border-color: var(--primary-light); }
        .verse-card.active { border-color: var(--primary); background-color: var(--highlight); box-shadow: var(--shadow); }

        .verse-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        .verse-badge {
            background: var(--bg-body);
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .link-indicator {
            background: var(--accent);
            color: #fff;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(217, 119, 6, 0.3);
            transition: transform 0.1s;
        }
        .link-indicator:hover { transform: scale(1.05); }

        .quran-text {
            font-family: var(--font-quran);
            font-size: var(--quran-size);
            color: var(--text-main);
            line-height: 1.9;
            direction: rtl;
            text-align: right;
            margin-bottom: 10px;
        }

        .trans-text {
            font-size: var(--trans-size);
            color: var(--text-muted);
            line-height: 1.6;
            direction: ltr;
            text-align: left;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
        }

        /* === MOBILE INLINE CONTEXT === */
        .mobile-context-container {
            display: none;
            margin-top: 20px;
            background: var(--bg-body);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* === LINK CARDS === */
        .link-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .link-card:hover { border-color: var(--accent); }

        .link-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .link-ref { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .badge-direct { background: #dcfce7; color: #166534; }
        .badge-parallel { background: #fef3c7; color: #92400e; }
        [data-theme="dark"] .badge-direct { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .badge-parallel { background: #78350f; color: #fcd34d; }

        /* Highlight in Search Results */
        mark { background: rgba(255, 213, 79, 0.4); color: inherit; padding: 0 2px; border-radius: 2px; }

        .loading { padding: 20px; text-align: center; color: var(--text-muted); font-style: italic; }

        /* === RESPONSIVE === */
        @media (max-width: 850px) {
            #side-panel { display: none; } 
            header { flex-wrap: wrap; padding: 10px; }
            .search-wrap { order: 3; width: 100%; max-width: none; margin-top: 10px; }
            .verse-card { padding: 1rem; }
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; color:var(--primary); font-size:1.2rem;">QuranViz</div>

    <div class="controls">
        <select id="surah-select" class="form-control" onchange="changeSurah(this.value)" style="max-width: 150px;"></select>
        
        <div style="display:flex; align-items:center; gap:2px;">
            <span style="font-size:10px">A</span>
            <input type="range" min="24" max="52" value="32" oninput="changeFontSize(this.value)">
            <span style="font-size:14px; font-weight:bold">A</span>
        </div>

        <button onclick="toggleLang()" id="lang-btn" class="btn-icon" title="Switch Language">EN</button>
        <button onclick="toggleTheme()" id="theme-btn" class="btn-icon" title="Toggle Theme">ğŸŒ™</button>
    </div>

    <div class="search-wrap">
        <input type="text" id="search-input" class="form-control" placeholder="Search..." onkeyup="debouncedSearch(event)">
    </div>
</header>

<main>
    <div id="reader-panel">
        <div id="quran-container">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <aside id="side-panel">
        <div id="side-panel-header">
            <span id="panel-title">Connections</span>
        </div>
        <div id="side-panel-content">
            <div style="text-align: center; color: var(--text-muted); margin-top: 50px; padding: 20px;">
                Select a verse with the <span style="background:var(--accent); color:white; padding:2px 6px; border-radius:4px; font-size:10px;">ğŸ”—</span> badge.
            </div>
        </div>
    </aside>
</main>

<script>
    // ==========================================
    // 1. DATA: Surah Names & Dummy Links
    // ==========================================
    const QURAN_LINKS = {
        "1:1": [{surah: 27, verse: 30, type: "Direct"}],
        "1:2": [{surah: 6, verse: 45, type: "Parallel"}, {surah: 10, verse: 10, type: "Parallel"}],
        "1:4": [{surah: 82, verse: 19, type: "Direct"}],
        "1:5": [{surah: 2, verse: 21, type: "Direct"}],
        "1:6": [{surah: 2, verse: 142, type: "Parallel"}]
    };

    const SURAH_NAMES = [
        "Al-Fatiha - Ø§Ù„ÙØ§ØªØ­Ø©", "Al-Baqarah - Ø§Ù„Ø¨Ù‚Ø±Ø©", "Al-Imran - Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "An-Nisa - Ø§Ù„Ù†Ø³Ø§Ø¡", "Al-Ma'idah - Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", 
        "Al-An'am - Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Al-A'raf - Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Al-Anfal - Ø§Ù„Ø£Ù†ÙØ§Ù„", "At-Tawbah - Ø§Ù„ØªÙˆØ¨Ø©", "Yunus - ÙŠÙˆÙ†Ø³", 
        "Hud - Ù‡ÙˆØ¯", "Yusuf - ÙŠÙˆØ³Ù", "Ar-Ra'd - Ø§Ù„Ø±Ø¹Ø¯", "Ibrahim - Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Al-Hijr - Ø§Ù„Ø­Ø¬Ø±", 
        "An-Nahl - Ø§Ù„Ù†Ø­Ù„", "Al-Isra - Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Al-Kahf - Ø§Ù„ÙƒÙ‡Ù", "Maryam - Ù…Ø±ÙŠÙ…", "Ta-Ha - Ø·Ù‡", 
        "Al-Anbiya - Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Al-Hajj - Ø§Ù„Ø­Ø¬", "Al-Mu'minun - Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "An-Nur - Ø§Ù„Ù†ÙˆØ±", "Al-Furqan - Ø§Ù„ÙØ±Ù‚Ø§Ù†", 
        "Ash-Shu'ara - Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "An-Naml - Ø§Ù„Ù†Ù…Ù„", "Al-Qasas - Ø§Ù„Ù‚ØµØµ", "Al-Ankabut - Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ar-Rum - Ø§Ù„Ø±ÙˆÙ…", 
        "Luqman - Ù„Ù‚Ù…Ø§Ù†", "As-Sajdah - Ø§Ù„Ø³Ø¬Ø¯Ø©", "Al-Ahzab - Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Saba - Ø³Ø¨Ø£", "Fatir - ÙØ§Ø·Ø±", 
        "Ya-Sin - ÙŠØ³", "As-Saffat - Ø§Ù„ØµØ§ÙØ§Øª", "Sad - Øµ", "Az-Zumar - Ø§Ù„Ø²Ù…Ø±", "Ghafir - ØºØ§ÙØ±", 
        "Fussilat - ÙØµÙ„Øª", "Ash-Shura - Ø§Ù„Ø´ÙˆØ±Ù‰", "Az-Zukhruf - Ø§Ù„Ø²Ø®Ø±Ù", "Ad-Dukhan - Ø§Ù„Ø¯Ø®Ø§Ù†", "Al-Jathiyah - Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", 
        "Al-Ahqaf - Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Muhammad - Ù…Ø­Ù…Ø¯", "Al-Fath - Ø§Ù„ÙØªØ­", "Al-Hujurat - Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Qaf - Ù‚", 
        "Ad-Dhariyat - Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "At-Tur - Ø§Ù„Ø·ÙˆØ±", "An-Najm - Ø§Ù„Ù†Ø¬Ù…", "Al-Qamar - Ø§Ù„Ù‚Ù…Ø±", "Ar-Rahman - Ø§Ù„Ø±Ø­Ù…Ù†", 
        "Al-Waqi'ah - Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Al-Hadid - Ø§Ù„Ø­Ø¯ÙŠØ¯", "Al-Mujadila - Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Al-Hashr - Ø§Ù„Ø­Ø´Ø±", "Al-Mumtahanah - Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", 
        "As-Saff - Ø§Ù„ØµÙ", "Al-Jumu'ah - Ø§Ù„Ø¬Ù…Ø¹Ø©", "Al-Munafiqun - Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "At-Taghabun - Ø§Ù„ØªØºØ§Ø¨Ù†", "At-Talaq - Ø§Ù„Ø·Ù„Ø§Ù‚", 
        "At-Tahrim - Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Al-Mulk - Ø§Ù„Ù…Ù„Ùƒ", "Al-Qalam - Ø§Ù„Ù‚Ù„Ù…", "Al-Haqqah - Ø§Ù„Ø­Ø§Ù‚Ø©", "Al-Ma'arij - Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", 
        "Nuh - Ù†ÙˆØ­", "Al-Jinn - Ø§Ù„Ø¬Ù†", "Al-Muzzammil - Ø§Ù„Ù…Ø²Ù…Ù„", "Al-Muddathir - Ø§Ù„Ù…Ø¯Ø«Ø±", "Al-Qiyamah - Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", 
        "Al-Insan - Ø§Ù„Ø§Ù†Ø³Ø§Ù†", "Al-Mursalat - Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "An-Naba - Ø§Ù„Ù†Ø¨Ø£", "An-Nazi'at - Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Abasa - Ø¹Ø¨Ø³", 
        "At-Takwir - Ø§Ù„ØªÙƒÙˆÙŠØ±", "Al-Infitar - Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±", "Al-Mutaffifin - Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Al-Inshiqaq - Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚", "Al-Buruj - Ø§Ù„Ø¨Ø±ÙˆØ¬", 
        "At-Tariq - Ø§Ù„Ø·Ø§Ø±Ù‚", "Al-A'la - Ø§Ù„Ø£Ø¹Ù„Ù‰", "Al-Ghashiyah - Ø§Ù„ØºØ§Ø´ÙŠØ©", "Al-Fajr - Ø§Ù„ÙØ¬Ø±", "Al-Balad - Ø§Ù„Ø¨Ù„Ø¯", 
        "Ash-Shams - Ø§Ù„Ø´Ù…Ø³", "Al-Layl - Ø§Ù„Ù„ÙŠÙ„", "Ad-Duha - Ø§Ù„Ø¶Ø­Ù‰", "Ash-Sharh - Ø§Ù„Ø´Ø±Ø­", "At-Tin - Ø§Ù„ØªÙŠÙ†", 
        "Al-Alaq - Ø§Ù„Ø¹Ù„Ù‚", "Al-Qadr - Ø§Ù„Ù‚Ø¯Ø±", "Al-Bayyinah - Ø§Ù„Ø¨ÙŠÙ†Ø©", "Az-Zalzalah - Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Al-Adiyat - Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", 
        "Al-Qari'ah - Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "At-Takathur - Ø§Ù„ØªÙƒØ§Ø«Ø±", "Al-Asr - Ø§Ù„Ø¹ØµØ±", "Al-Humazah - Ø§Ù„Ù‡Ù…Ø²Ø©", "Al-Fil - Ø§Ù„ÙÙŠÙ„", 
        "Quraysh - Ù‚Ø±ÙŠØ´", "Al-Ma'un - Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Al-Kawthar - Ø§Ù„ÙƒÙˆØ«Ø±", "Al-Kafirun - Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "An-Nasr - Ø§Ù„Ù†ØµØ±", 
        "Al-Masad - Ø§Ù„Ù…Ø³Ø¯", "Al-Ikhlas - Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Al-Falaq - Ø§Ù„ÙÙ„Ù‚", "An-Nas - Ø§Ù„Ù†Ø§Ø³"
    ];

    const STATE = {
        lang: 'ar',
        currentSurah: 1,
        activeVerseKey: null,
        theme: 'light',
        isMobile: window.innerWidth <= 850
    };

    const UI = {
        ar: { title: "Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„Ù…ØªØ±Ø§Ø¨Ø·", search: "Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†...", refs: "Ø§Ù„Ø±ÙˆØ§Ø¨Ø·", lang: "EN", loading: "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...", noLinks: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ©", direct: "Ù…Ø¨Ø§Ø´Ø±", parallel: "Ù…ÙˆØ¶ÙˆØ¹ÙŠ", noResults: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬", connectionLabel: "Ø±ÙˆØ§Ø¨Ø·" },
        en: { title: "QuranViz", search: "Search Quran...", refs: "Connections", lang: "Ø¹Ø±Ø¨ÙŠ", loading: "Loading...", noLinks: "No connections found.", direct: "Direct", parallel: "Thematic", noResults: "No results found", connectionLabel: "Links" }
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelect();
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) toggleTheme();
        loadSurah(1);
        updateUI();

        window.addEventListener('resize', () => {
            const mobile = window.innerWidth <= 850;
            if (mobile !== STATE.isMobile) {
                STATE.isMobile = mobile;
                if(STATE.activeVerseKey) activateVerse(STATE.activeVerseKey, true);
            }
        });
    });

    // --- LOGIC ---

    async function loadSurah(surahId, scrollToVerse = null) {
        STATE.currentSurah = parseInt(surahId);
        const container = document.getElementById('quran-container');
        container.innerHTML = `<div class="loading">${UI[STATE.lang].loading}</div>`;
        document.getElementById('surah-select').value = surahId;

        // Reset sidebar
        document.getElementById('side-panel-content').innerHTML = '';

        try {
            // Fetch Uthmani (Arabic) + Sahih (English) always to be safe, then hide via CSS/Logic
            let editions = 'quran-uthmani,en.sahih';
            
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahId}/editions/${editions}`);
            const data = await res.json();
            
            const ayahsAr = data.data[0].ayahs;
            const ayahsEn = data.data[1].ayahs;

            container.innerHTML = '';

            ayahsAr.forEach((ayah, idx) => {
                const verseKey = `${surahId}:${ayah.numberInSurah}`;
                const links = QURAN_LINKS[verseKey];
                const hasLinks = links && links.length > 0;
                
                const card = document.createElement('div');
                card.className = 'verse-card';
                card.id = `verse-${verseKey}`;
                card.dataset.key = verseKey;

                // Click event
                card.onclick = (e) => {
                    if(e.target.closest('.mobile-context-container')) return;
                    // In mobile, we might want to tap anywhere to open, 
                    // but let's stick to the Badge for clarity unless it's just reading
                    if(hasLinks) activateVerse(verseKey);
                };

                // Link Badge
                let linkBadgeHtml = '';
                if(hasLinks) {
                    linkBadgeHtml = `<div class="link-indicator" onclick="activateVerse('${verseKey}')">
                        <span>${links.length}</span>
                        <span>ğŸ”—</span>
                        <span style="font-size:10px">${UI[STATE.lang].connectionLabel}</span>
                    </div>`;
                }

                // Translation (Only show in English mode)
                let transHtml = '';
                if (STATE.lang === 'en') {
                    transHtml = `<div class="trans-text">${ayahsEn[idx].text}</div>`;
                }

                let html = `
                    <div class="verse-header">
                        <span class="verse-badge">${surahId}:${ayah.numberInSurah}</span>
                        ${linkBadgeHtml}
                    </div>
                    <div class="quran-text">${ayah.text}</div>
                    ${transHtml}
                    <div class="mobile-context-container" id="mobile-ctx-${verseKey}"></div>
                `;
                
                card.innerHTML = html;
                container.appendChild(card);
            });

            if (scrollToVerse) {
                setTimeout(() => {
                    const el = document.getElementById(`verse-${surahId}:${scrollToVerse}`);
                    if(el) {
                        el.scrollIntoView({behavior: "smooth", block: "center"});
                        activateVerse(`${surahId}:${scrollToVerse}`);
                    }
                }, 500);
            }

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="loading" style="color:red">Error loading surah. Please check internet.</div>`;
        }
    }

    function activateVerse(key, forceRefresh = false) {
        if (!forceRefresh && STATE.activeVerseKey === key && !STATE.isMobile) return;
        
        document.querySelectorAll('.verse-card').forEach(d => d.classList.remove('active'));
        const el = document.getElementById(`verse-${key}`);
        if(el) el.classList.add('active');
        
        document.querySelectorAll('.mobile-context-container').forEach(d => {
            d.innerHTML = ''; d.style.display = 'none';
        });

        STATE.activeVerseKey = key;

        if (STATE.isMobile) {
            const inlineContainer = document.getElementById(`mobile-ctx-${key}`);
            if(inlineContainer) {
                inlineContainer.style.display = 'block';
                loadLinksInto(key, inlineContainer);
            }
        } else {
            const sideContainer = document.getElementById('side-panel-content');
            document.getElementById('panel-title').innerText = `${UI[STATE.lang].refs} (${key})`;
            loadLinksInto(key, sideContainer);
        }
    }

    async function loadLinksInto(key, container) {
        const txt = UI[STATE.lang];
        container.innerHTML = `<div class="loading" style="padding:10px; font-size:12px;">${txt.loading}</div>`;
        
        const links = QURAN_LINKS[key];
        if (!links || links.length === 0) {
            container.innerHTML = `<div style="padding:15px; text-align:center; color:var(--text-muted); font-size:13px;">${txt.noLinks}</div>`;
            return;
        }

        let html = '';
        // Always display Uthmani for the reference cards
        const edition = 'quran-uthmani'; 

        for (const link of links) {
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${link.surah}:${link.verse}/${edition}`);
                const d = await res.json();
                
                const text = d.data.text;
                const meta = d.data.surah;
                const sName = SURAH_NAMES[link.surah - 1] || meta.englishName;
                
                const badgeClass = link.type === 'Parallel' ? 'badge-parallel' : 'badge-direct';
                const badgeLabel = link.type === 'Parallel' ? txt.parallel : txt.direct;
                
                html += `
                <div class="link-card" onclick="jumpToVerse(${link.surah}, ${link.verse})">
                    <div class="link-header">
                        <span class="link-ref">${sName} ${link.surah}:${link.verse}</span>
                        <span class="badge ${badgeClass}">${badgeLabel}</span>
                    </div>
                    <div style="font-family:var(--font-quran); font-size:20px; direction:rtl;">${text}</div>
                </div>`;
            } catch(e) {}
        }
        container.innerHTML = html;
    }

    // --- SEARCH LOGIC (FIXED) ---
    let searchTimeout;
    function debouncedSearch(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => doSearch(e.target.value), 600);
    }

    async function doSearch(query) {
        query = query.trim();
        const container = STATE.isMobile 
            ? document.getElementById('quran-container') 
            : document.getElementById('side-panel-content');

        if(!query) {
            if(STATE.isMobile) loadSurah(STATE.currentSurah);
            else container.innerHTML = ''; 
            return;
        }

        const txt = UI[STATE.lang];
        container.innerHTML = `<div class="loading">${txt.loading}</div>`;

        try {
            // 1. Detect Arabic
            const isArabicQuery = /[\u0600-\u06FF]/.test(query);
            
            // 2. Clean input (Remove Tashkeel for better matching)
            const cleanQuery = query.replace(/[\u064B-\u065F]/g, '');

            // 3. Choose Edition:
            // 'quran-simple-clean' is BEST for search (no diacritics, standard spelling)
            const edition = isArabicQuery ? 'quran-simple-clean' : 'en.sahih';
            
            const res = await fetch(`https://api.alquran.cloud/v1/search/${encodeURIComponent(cleanQuery)}/all/${edition}`);
            const data = await res.json();

            if (data.status !== 'OK' || !data.data.matches || data.data.matches.length === 0) {
                container.innerHTML = `<div style="padding:20px; text-align:center;">${txt.noResults}</div>`;
                return;
            }

            let html = `<div style="padding:10px; font-weight:bold; color:var(--primary); font-size:14px">Found ${data.data.count} results</div>`;
            
            const matches = data.data.matches.slice(0, 30); 

            matches.forEach(m => {
                const sName = SURAH_NAMES[m.surah.number - 1];
                const textStyle = isArabicQuery 
                    ? 'font-family:var(--font-quran); font-size: 22px; direction:rtl;' 
                    : 'font-size: 14px; direction:ltr;';

                // Highlight the query
                const regex = new RegExp(cleanQuery, 'gi');
                const highlightedText = m.text.replace(regex, match => `<mark>${match}</mark>`);

                html += `
                <div class="link-card" onclick="jumpToVerse(${m.surah.number}, ${m.numberInSurah})">
                    <div class="link-header">
                        <span class="link-ref">${sName} ${m.surah.number}:${m.numberInSurah}</span>
                    </div>
                    <div style="${textStyle}">${highlightedText}</div>
                </div>`;
            });
            
            container.innerHTML = html;
            if(STATE.isMobile) document.getElementById('reader-panel').scrollTop = 0;

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="loading" style="color:red">Search Error</div>`;
        }
    }

    // --- UTILS ---
    function jumpToVerse(surah, verse) {
        if (STATE.currentSurah === surah) {
            const el = document.getElementById(`verse-${surah}:${verse}`);
            if (el) {
                el.scrollIntoView({behavior: "smooth", block: "center"});
                activateVerse(`${surah}:${verse}`, true);
            }
        } else {
            loadSurah(surah, verse);
        }
    }

    function toggleTheme() {
        STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', STATE.theme);
        document.getElementById('theme-btn').innerText = STATE.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    function toggleLang() {
        STATE.lang = STATE.lang === 'ar' ? 'en' : 'ar';
        const isAr = STATE.lang === 'ar';
        document.documentElement.dir = isAr ? 'rtl' : 'ltr';
        updateUI();
        loadSurah(STATE.currentSurah); 
    }

    function changeFontSize(val) {
        document.documentElement.style.setProperty('--quran-size', val + 'px');
    }

    function changeSurah(val) {
        document.getElementById('search-input').value = '';
        loadSurah(val);
    }

    function updateUI() {
        const t = UI[STATE.lang];
        document.getElementById('search-input').placeholder = t.search;
        document.getElementById('lang-btn').innerText = t.lang;
        document.getElementById('panel-title').innerText = t.refs;
    }

    function populateSurahSelect() {
        const sel = document.getElementById('surah-select');
        sel.innerHTML = '';
        SURAH_NAMES.forEach((name, idx) => {
            const opt = document.createElement('option');
            opt.value = idx + 1;
            opt.innerText = `${idx+1}. ${name}`;
            sel.appendChild(opt);
        });
    }
</script>
</body>
</html>