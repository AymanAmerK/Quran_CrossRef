<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Quran Reader Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lateef&display=swap" rel="stylesheet">

    <style>
        /* === THEMES & VARIABLES === */
        :root {
            /* Default Light Theme */
            --primary: #104F3F;
            --accent: #D4AF37;
            --bg-main: #fcfcfc;
            --bg-panel: #f8f9fa;
            --text-main: #222;
            --text-muted: #666;
            --border: #e0e0e0;
            --highlight: rgba(212, 175, 55, 0.15);
            --font-ui: 'Amiri', serif;
            --font-quran: 'Lateef', serif; 
            --quran-size: 28px; /* Dynamic Font Size */
        }

        [data-theme="dark"] {
            --primary: #4DB6AC;
            --accent: #FFD54F;
            --bg-main: #121212;
            --bg-panel: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #aaa;
            --border: #333;
            --highlight: rgba(255, 213, 79, 0.15);
        }

        body { 
            margin: 0; 
            font-family: var(--font-ui); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
            background: var(--bg-main);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        /* === HEADER === */
        header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .logo { font-size: 20px; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        button, select, input {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-main);
            color: var(--text-main);
            font-family: var(--font-ui);
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Font Size Slider */
        .font-control { display: flex; align-items: center; gap: 5px; font-size: 12px; }
        input[type=range] { width: 60px; padding: 0; }

        .search-bar { width: 150px; }

        /* === MAIN LAYOUT === */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* READER PANEL */
        #reader-panel { 
            flex: 1; 
            overflow-y: auto; 
            padding: 0; 
            scroll-behavior: smooth;
        }

        /* SIDE PANEL (Context) */
        #side-panel { 
            width: 35%; 
            max-width: 400px;
            min-width: 300px;
            border-inline-start: 1px solid var(--border); 
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
        }

        /* === MOBILE LAYOUT (TABS) === */
        .mobile-tabs { display: none; }

        @media (max-width: 768px) {
            header { padding: 10px; }
            .search-bar { width: 100px; }
            .logo span { display: none; } /* Hide text logo on small screens */

            /* Stack panels absolute to toggle visibility */
            #reader-panel, #side-panel {
                width: 100%;
                border: none;
                position: absolute;
                top: 0; bottom: 50px; /* Leave space for tabs */
                left: 0; right: 0;
            }
            
            #side-panel { display: none; } /* Hidden by default */
            #side-panel.active { display: flex; z-index: 20; }
            
            /* Bottom Tab Bar */
            .mobile-tabs {
                display: flex;
                height: 50px;
                background: var(--bg-panel);
                border-top: 1px solid var(--border);
                justify-content: space-around;
                align-items: center;
                z-index: 50;
            }
            .tab-btn {
                flex: 1;
                text-align: center;
                padding: 10px;
                font-weight: bold;
                color: var(--text-muted);
                border: none; background: none;
            }
            .tab-btn.active { color: var(--primary); border-top: 3px solid var(--accent); }
        }

        /* === VERSE STYLING === */
        .verse-row {
            padding: 30px 20px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        .verse-row.active { background-color: var(--highlight); border-inline-start: 4px solid var(--accent); }
        
        .quran-text {
            font-family: var(--font-quran);
            font-size: var(--quran-size);
            line-height: 1.8;
            color: var(--text-main);
            margin-bottom: 15px;
            direction: rtl;
            text-align: right;
        }
        
        .trans-text {
            font-size: calc(var(--quran-size) * 0.6);
            color: var(--text-muted);
            line-height: 1.5;
        }

        .verse-num-badge {
            background: var(--border);
            color: var(--text-muted);
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: inline-block;
        }

        /* === CARDS (Context) === */
        .card {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .card:hover { border-color: var(--accent); }
        
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-direct { background: #e8f5e9; color: #2e7d32; }
        .badge-parallel { background: #fff3e0; color: #ef6c00; }
        [data-theme="dark"] .badge-direct { background: #1b5e20; color: #a5d6a7; }
        [data-theme="dark"] .badge-parallel { background: #e65100; color: #ffcc80; }

        .hidden { display: none !important; }
        .loading { text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; }

    </style>
</head>
<body>

<header>
    <div class="logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
        <span>QuranViz</span>
    </div>
    
    <div class="controls">
        <input type="text" id="search-input" class="search-bar" placeholder="Search..." onkeyup="handleSearch(event)">
        
        <select id="surah-select" onchange="changeSurah(this.value)"></select>
        
        <div class="font-control">
            <span>A</span>
            <input type="range" min="18" max="48" value="28" oninput="changeFontSize(this.value)">
            <span style="font-size:16px; font-weight:bold">A</span>
        </div>

        <button onclick="toggleTheme()" id="theme-btn">üåô</button>
        
        <button onclick="toggleLang()" id="lang-btn">EN</button>
    </div>
</header>

<main>
    <div id="reader-panel">
        <div id="quran-container">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <aside id="side-panel">
        <div style="padding: 15px; border-bottom: 1px solid var(--border); font-weight:bold; color:var(--primary)" id="panel-title">
            Cross-References
        </div>
        <div id="panel-content" style="flex:1; overflow-y:auto; padding:15px;">
            <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">
                Start reading to see connections.
            </div>
        </div>
    </aside>
</main>

<div class="mobile-tabs">
    <button class="tab-btn active" onclick="switchTab('reader')" id="tab-reader">üìñ Reader</button>
    <button class="tab-btn" onclick="switchTab('context')" id="tab-context">üîó Links</button>
</div>

<script>
    // ==========================================
    // 1. PASTE YOUR QURAN_LINKS.JS DATA HERE
    // ==========================================
    // Replace this dummy data with your FULL dataset
    const QURAN_LINKS = {
        "1:2": [{surah: 26, verse: 23, type: "Direct"}, {surah: 26, verse: 24, type: "Direct"}],
        "1:4": [{surah: 82, verse: 19, type: "Direct"}],
        "1:6": [{surah: 2, verse: 142, type: "Parallel"}]
    };
    // ==========================================

    const STATE = {
        lang: 'ar',
        currentSurah: 1,
        activeVerseKey: null,
        theme: 'light'
    };

    const UI = {
        ar: { title: "ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÖÿ™ÿ±ÿßÿ®ÿ∑", search: "ÿ®ÿ≠ÿ´...", refs: "ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑", lang: "EN", loading: "ÿ¨ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", tabRead: "ÿßŸÑŸÇÿßÿ±ÿ¶", tabLink: "ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑", noLinks: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±Ÿàÿßÿ®ÿ∑" },
        en: { title: "QuranViz", search: "Search...", refs: "Connections", lang: "ÿπÿ±ÿ®Ÿä", loading: "Loading...", tabRead: "Reader", tabLink: "Links", noLinks: "No links found" }
    };

    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelect();
        // Check system theme preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            toggleTheme();
        }
        loadSurah(1);
        updateUIText();
    });

    // --- UI FUNCTIONS ---
    function toggleTheme() {
        STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', STATE.theme);
        document.getElementById('theme-btn').innerText = STATE.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }

    function changeFontSize(val) {
        document.documentElement.style.setProperty('--quran-size', val + 'px');
    }

    function toggleLang() {
        STATE.lang = STATE.lang === 'ar' ? 'en' : 'ar';
        const isAr = STATE.lang === 'ar';
        document.documentElement.dir = isAr ? 'rtl' : 'ltr';
        loadSurah(STATE.currentSurah); // Reload to fetch correct translation
        updateUIText();
    }

    function updateUIText() {
        const txt = UI[STATE.lang];
        document.querySelector('.logo span').innerText = txt.title;
        document.getElementById('search-input').placeholder = txt.search;
        document.getElementById('panel-title').innerText = txt.refs;
        document.getElementById('lang-btn').innerText = txt.lang;
        document.getElementById('tab-reader').innerText = txt.tabRead;
        document.getElementById('tab-context').innerText = txt.tabLink;
    }

    function switchTab(tab) {
        // Mobile only
        const reader = document.getElementById('reader-panel');
        const side = document.getElementById('side-panel');
        const tabR = document.getElementById('tab-reader');
        const tabC = document.getElementById('tab-context');

        if (tab === 'reader') {
            reader.style.display = 'block';
            side.classList.remove('active');
            tabR.classList.add('active');
            tabC.classList.remove('active');
        } else {
            // reader.style.display = 'none'; // Optional: keep reader in background
            side.classList.add('active');
            tabR.classList.remove('active');
            tabC.classList.add('active');
        }
    }

    // --- CORE LOGIC ---
    async function loadSurah(surahId, scrollToVerse = null) {
        STATE.currentSurah = parseInt(surahId);
        const container = document.getElementById('quran-container');
        container.innerHTML = `<div class="loading">${UI[STATE.lang].loading}</div>`;
        document.getElementById('surah-select').value = surahId;

        try {
            // API LOGIC:
            // AR Mode: Get 'quran-uthmani' only. (No Translation)
            // EN Mode: Get 'quran-uthmani' + 'en.sahih'
            
            let editions = 'quran-uthmani'; 
            if (STATE.lang === 'en') editions += ',en.sahih';

            const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahId}/editions/${editions}`);
            const data = await res.json();
            
            const ayahs = data.data[0].ayahs;
            const trans = data.data.length > 1 ? data.data[1].ayahs : null;

            container.innerHTML = '';

            ayahs.forEach((ayah, idx) => {
                const verseKey = `${surahId}:${ayah.numberInSurah}`;
                const div = document.createElement('div');
                div.className = 'verse-row';
                div.id = `verse-${verseKey}`;
                div.dataset.key = verseKey;
                
                let html = `<span class="verse-num-badge">${ayah.numberInSurah}</span>`;
                html += `<div class="quran-text">${ayah.text}</div>`;
                if (trans) html += `<div class="trans-text">${trans[idx].text}</div>`;

                div.innerHTML = html;
                div.onclick = () => activateVerse(verseKey);
                observer.observe(div);
                container.appendChild(div);
            });

            if (scrollToVerse) {
                setTimeout(() => {
                    const el = document.getElementById(`verse-${surahId}:${scrollToVerse}`);
                    if(el) {
                        el.scrollIntoView({behavior: "smooth", block: "center"});
                        activateVerse(`${surahId}:${scrollToVerse}`);
                    }
                }, 500);
            }
        } catch (e) {
            container.innerHTML = `<div class="loading" style="color:red">Error loading surah</div>`;
        }
    }

    // --- OBSERVER ---
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if(entry.isIntersecting && entry.intersectionRatio > 0.6) {
                activateVerse(entry.target.dataset.key);
            }
        });
    }, { root: document.getElementById('reader-panel'), threshold: 0.6 });

    function activateVerse(key) {
        if (STATE.activeVerseKey === key) return;
        STATE.activeVerseKey = key;

        document.querySelectorAll('.verse-row').forEach(d => d.classList.remove('active'));
        const el = document.getElementById(`verse-${key}`);
        if(el) el.classList.add('active');

        loadContext(key);
    }

    // --- LOAD CONNECTIONS ---
    async function loadContext(key) {
        document.getElementById('panel-title').innerText = `${UI[STATE.lang].refs} (${key})`;
        const container = document.getElementById('panel-content');
        
        const links = QURAN_LINKS[key];

        if (!links || links.length === 0) {
            container.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted)">${UI[STATE.lang].noLinks}</div>`;
            return;
        }

        container.innerHTML = `<div class="loading">${UI[STATE.lang].loading}</div>`;
        
        // Decide which edition to fetch for references
        // If App is in Arabic, fetch Arabic text. If English, fetch English translation.
        const refEdition = STATE.lang === 'ar' ? 'quran-uthmani' : 'en.sahih';

        let html = '';
        for (const link of links) {
            try {
                // Fetch each link
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${link.surah}:${link.verse}/${refEdition}`);
                const d = await res.json();
                
                const text = d.data.text;
                const meta = d.data.surah;
                const surahName = STATE.lang === 'ar' ? meta.name : meta.englishName;
                
                const badge = link.type === 'Parallel' ? 'badge-parallel' : 'badge-direct';
                const badgeTxt = link.type === 'Parallel' ? 'Parallel' : 'Direct';

                // Styling text based on language
                const textStyle = STATE.lang === 'ar' 
                    ? 'font-family:var(--font-quran); font-size:22px; direction:rtl;' 
                    : 'font-size:14px; direction:ltr;';

                html += `
                <div class="card" onclick="jumpToVerse(${link.surah}, ${link.verse})">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-weight:bold; color:var(--primary)">${surahName} ${link.surah}:${link.verse}</span>
                        <span class="badge ${badge}">${badgeTxt}</span>
                    </div>
                    <div style="${textStyle}">${text}</div>
                </div>`;
            } catch(e) {}
        }
        container.innerHTML = html;
    }

    // --- SEARCH ---
    async function handleSearch(e) {
        if (e.key === 'Enter') {
            const query = e.target.value;
            if(!query) return;

            const panel = document.getElementById('panel-content');
            document.getElementById('panel-title').innerText = "Results / ŸÜÿ™ÿßÿ¶ÿ¨";
            panel.innerHTML = `<div class="loading">${UI[STATE.lang].loading}</div>`;
            
            // Switch to Links Tab on mobile automatically
            if(window.innerWidth < 768) switchTab('context');

            try {
                // CRITICAL FIX: Restrict search to specific editions to avoid Tafsir junk
                const edition = STATE.lang === 'ar' ? 'quran-uthmani' : 'en.sahih';
                
                const res = await fetch(`https://api.alquran.cloud/v1/search/${query}/all/${edition}`);
                const data = await res.json();
                
                if(!data.data || data.data.matches.length === 0) {
                    panel.innerHTML = `<div style="padding:20px;">No results.</div>`;
                    return;
                }

                let html = '';
                data.data.matches.forEach(m => {
                    const surahName = STATE.lang === 'ar' ? m.surah.name : m.surah.englishName;
                    const textStyle = STATE.lang === 'ar' ? 'font-family:var(--font-quran); font-size:20px;' : 'font-size:14px;';

                    html += `
                    <div class="card" onclick="jumpToVerse(${m.surah.number}, ${m.numberInSurah})">
                        <div style="font-weight:bold; color:var(--primary)">${surahName} (${m.numberInSurah})</div>
                        <div style="${textStyle}">${m.text}</div>
                    </div>`;
                });
                panel.innerHTML = html;

            } catch (e) {
                panel.innerHTML = "Error searching / ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´";
            }
        }
    }

    function jumpToVerse(surah, verse) {
        if(window.innerWidth < 768) switchTab('reader'); // Switch back to reader on mobile
        
        if (STATE.currentSurah === surah) {
            const el = document.getElementById(`verse-${surah}:${verse}`);
            if (el) {
                el.scrollIntoView({behavior: "smooth", block: "center"});
                activateVerse(`${surah}:${verse}`);
            }
        } else {
            document.getElementById('surah-select').value = surah;
            loadSurah(surah, verse);
        }
    }
    
    function changeSurah(val) {
        loadSurah(val);
    }

    function populateSurahSelect() {
        const sel = document.getElementById('surah-select');
        for(let i=1; i<=114; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = STATE.lang === 'ar' ? i : `Surah ${i}`;
            sel.appendChild(opt);
        }
    }

</script>
</body>
</html>