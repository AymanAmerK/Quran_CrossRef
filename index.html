<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuranViz Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Lateef&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* === VARIABLES & THEME === */
        :root {
            /* Palette */
            --primary: #0f766e; /* Deep Teal */
            --primary-light: #14b8a6;
            --accent: #d97706; /* Gold/Amber */
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --highlight: #f0fdf4; /* Light Green */
            
            /* Typography */
            --font-ui: 'Inter', system-ui, sans-serif;
            --font-quran: 'Lateef', serif; 
            
            /* Dynamic Sizes */
            --quran-size: 32px; 
            --trans-size: calc(var(--quran-size) * 0.55);
        }

        [data-theme="dark"] {
            --primary: #2dd4bf;
            --primary-light: #5eead4;
            --accent: #fbbf24;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --highlight: rgba(45, 212, 191, 0.1);
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            font-family: var(--font-ui); 
            background: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* === HEADER === */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            z-index: 50;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Inputs & Buttons */
        .btn-icon, .form-control {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .form-control:focus { border-color: var(--primary); }
        .btn-icon { cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { border-color: var(--primary); color: var(--primary); }

        input[type=range] { width: 80px; accent-color: var(--primary); cursor: pointer; }
        .search-wrap { position: relative; }

        /* === MAIN LAYOUT === */
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left/Top Panel: Reader */
        #reader-panel {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        /* Right Panel: Context (Desktop) */
        #side-panel {
            width: 380px;
            background: var(--bg-card);
            border-inline-start: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.05);
        }
        
        #side-panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #side-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* === VERSE STYLING === */
        .verse-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background-color 0.2s;
        }

        .verse-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
        }

        .verse-card.active {
            border-color: var(--primary);
            background-color: var(--highlight);
            box-shadow: var(--shadow);
        }

        .verse-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .verse-badge {
            background: var(--bg-body);
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .quran-text {
            font-family: var(--font-quran);
            font-size: var(--quran-size);
            color: var(--text-main);
            line-height: 1.9;
            direction: rtl;
            text-align: right;
            margin-bottom: 10px;
        }

        .trans-text {
            font-size: var(--trans-size);
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* === MOBILE INLINE CONTEXT (The Fix) === */
        .mobile-context-container {
            display: none; /* Hidden on desktop */
            margin-top: 15px;
            background: var(--bg-body);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* === LINK CARDS === */
        .link-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .link-card:hover { border-color: var(--accent); }

        .link-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .link-ref { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-direct { background: #dcfce7; color: #166534; }
        .badge-parallel { background: #fef3c7; color: #92400e; }
        [data-theme="dark"] .badge-direct { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .badge-parallel { background: #78350f; color: #fcd34d; }

        .loading { padding: 20px; text-align: center; color: var(--text-muted); font-style: italic; }

        /* === RESPONSIVE LOGIC === */
        @media (max-width: 850px) {
            /* HIDE SIDE PANEL ON MOBILE */
            #side-panel { display: none; } 
            
            /* SHOW INLINE CONTAINER ON MOBILE */
            .mobile-context-container { display: block; }

            header { flex-wrap: wrap; gap: 10px; padding: 10px; }
            .brand span { display: none; } /* Hide Title on small screens */
            .search-wrap { flex: 1; order: 1; min-width: 100%; }
            .controls { flex: 1; justify-content: space-between; width: 100%; order: 2; }
            #search-input { width: 100%; }
            
            .verse-card { padding: 1rem; }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
        <span>QuranViz</span>
    </div>

    <div class="search-wrap">
        <input type="text" id="search-input" class="form-control" placeholder="Search..." onkeyup="debouncedSearch(event)">
    </div>

    <div class="controls">
        <select id="surah-select" class="form-control" onchange="changeSurah(this.value)" style="max-width: 120px;"></select>
        
        <div style="display:flex; align-items:center; gap:5px;">
            <span style="font-size:12px">A</span>
            <input type="range" min="24" max="52" value="32" oninput="changeFontSize(this.value)">
            <span style="font-size:16px; font-weight:bold">A</span>
        </div>

        <button onclick="toggleLang()" id="lang-btn" class="btn-icon" title="Switch Language">EN</button>
        <button onclick="toggleTheme()" id="theme-btn" class="btn-icon" title="Toggle Theme">üåô</button>
    </div>
</header>

<main>
    <div id="reader-panel">
        <div id="quran-container">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <aside id="side-panel">
        <div id="side-panel-header">
            <span id="panel-title">Connections</span>
            <span style="font-size: 12px; color: var(--text-muted);">Click a verse</span>
        </div>
        <div id="side-panel-content">
            <div style="text-align: center; color: var(--text-muted); margin-top: 50px; padding: 20px;">
                <svg width="40" height="40" style="opacity:0.3; margin-bottom:10px" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
                <br>Select a verse to see cross-references.
            </div>
        </div>
    </aside>
</main>

<script>
    // ==========================================
    // 1. DUMMY DATA (Replace with QURAN_LINKS.JS)
    // ==========================================
    const QURAN_LINKS = {
        "1:1": [{surah: 27, verse: 30, type: "Direct"}],
        "1:2": [{surah: 6, verse: 45, type: "Parallel"}, {surah: 10, verse: 10, type: "Parallel"}],
        "1:4": [{surah: 82, verse: 19, type: "Direct"}],
        "1:5": [{surah: 2, verse: 21, type: "Direct"}],
        "1:6": [{surah: 2, verse: 142, type: "Parallel"}]
    };
    // ==========================================

    const STATE = {
        lang: 'ar', // 'ar' or 'en'
        currentSurah: 1,
        activeVerseKey: null,
        theme: 'light',
        isMobile: window.innerWidth <= 850
    };

    const UI = {
        ar: { title: "ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÖÿ™ÿ±ÿßÿ®ÿ∑", search: "ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇÿ±ÿ¢ŸÜ...", refs: "ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑", lang: "EN", loading: "ÿ¨ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", noLinks: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±Ÿàÿßÿ®ÿ∑ ŸÑŸáÿ∞Ÿá ÿßŸÑÿ¢Ÿäÿ©", direct: "ŸÖÿ®ÿßÿ¥ÿ±", parallel: "ŸÖŸàÿ∂ŸàÿπŸä", noResults: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨" },
        en: { title: "QuranViz", search: "Search Quran...", refs: "Connections", lang: "ÿπÿ±ÿ®Ÿä", loading: "Loading...", noLinks: "No connections found.", direct: "Direct", parallel: "Thematic", noResults: "No results found" }
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelect();
        // Detect System Theme
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) toggleTheme();
        
        loadSurah(1);
        updateUI();

        // Listen for Resize to handle layout changes
        window.addEventListener('resize', () => {
            const mobile = window.innerWidth <= 850;
            if (mobile !== STATE.isMobile) {
                STATE.isMobile = mobile;
                // Re-activate current verse to adjust layout (move links from side to inline or vice versa)
                if(STATE.activeVerseKey) activateVerse(STATE.activeVerseKey, true);
            }
        });
    });

    // --- LOGIC ---

    async function loadSurah(surahId, scrollToVerse = null) {
        STATE.currentSurah = parseInt(surahId);
        const container = document.getElementById('quran-container');
        container.innerHTML = `<div class="loading">${UI[STATE.lang].loading}</div>`;
        document.getElementById('surah-select').value = surahId;

        // Reset Context Panel
        document.getElementById('side-panel-content').innerHTML = '';

        try {
            // Fetch: Always get Arabic + English for Translation display
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahId}/editions/quran-uthmani,en.sahih`);
            const data = await res.json();
            
            const ayahsAr = data.data[0].ayahs;
            const ayahsEn = data.data[1].ayahs;

            container.innerHTML = '';

            ayahsAr.forEach((ayah, idx) => {
                const verseKey = `${surahId}:${ayah.numberInSurah}`;
                
                // Create Card
                const card = document.createElement('div');
                card.className = 'verse-card';
                card.id = `verse-${verseKey}`;
                card.dataset.key = verseKey;
                card.onclick = (e) => {
                    // Prevent closing if clicking inside the mobile context container
                    if(e.target.closest('.mobile-context-container')) return;
                    activateVerse(verseKey);
                };

                // HTML Structure
                let html = `
                    <div class="verse-header">
                        <span class="verse-badge">${surahId}:${ayah.numberInSurah}</span>
                    </div>
                    <div class="quran-text">${ayah.text}</div>
                    <div class="trans-text">${ayahsEn[idx].text}</div>
                    
                    <div class="mobile-context-container" id="mobile-ctx-${verseKey}"></div>
                `;
                
                card.innerHTML = html;
                container.appendChild(card);
            });

            if (scrollToVerse) {
                setTimeout(() => {
                    const el = document.getElementById(`verse-${surahId}:${scrollToVerse}`);
                    if(el) {
                        el.scrollIntoView({behavior: "smooth", block: "center"});
                        activateVerse(`${surahId}:${scrollToVerse}`);
                    }
                }, 500);
            }

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="loading" style="color:red">Failed to load content. Check internet.</div>`;
        }
    }

    // --- INTERACTION ---

    function activateVerse(key, forceRefresh = false) {
        if (!forceRefresh && STATE.activeVerseKey === key && !STATE.isMobile) return;
        
        // 1. Highlight Visuals
        document.querySelectorAll('.verse-card').forEach(d => d.classList.remove('active'));
        const el = document.getElementById(`verse-${key}`);
        if(el) el.classList.add('active');
        
        // 2. Hide all previous mobile containers
        document.querySelectorAll('.mobile-context-container').forEach(d => {
            d.innerHTML = ''; 
            d.style.display = 'none';
        });

        STATE.activeVerseKey = key;

        // 3. Load Context Data
        if (STATE.isMobile) {
            // Mobile: Load into the inline container
            const inlineContainer = document.getElementById(`mobile-ctx-${key}`);
            inlineContainer.style.display = 'block';
            loadLinksInto(key, inlineContainer);
        } else {
            // Desktop: Load into side panel
            const sideContainer = document.getElementById('side-panel-content');
            document.getElementById('panel-title').innerText = `${UI[STATE.lang].refs} (${key})`;
            loadLinksInto(key, sideContainer);
        }
    }

    async function loadLinksInto(key, container) {
        const txt = UI[STATE.lang];
        container.innerHTML = `<div class="loading" style="padding:10px; font-size:12px;">${txt.loading}</div>`;
        
        const links = QURAN_LINKS[key];

        if (!links || links.length === 0) {
            container.innerHTML = `<div style="padding:15px; text-align:center; color:var(--text-muted); font-size:13px;">${txt.noLinks}</div>`;
            return;
        }

        let html = '';
        const edition = STATE.lang === 'ar' ? 'quran-uthmani' : 'en.sahih';

        // NOTE: In production, batch request these IDs to save API calls
        for (const link of links) {
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${link.surah}:${link.verse}/${edition}`);
                const d = await res.json();
                
                const text = d.data.text;
                const meta = d.data.surah;
                const sName = STATE.lang === 'ar' ? meta.name : meta.englishName;
                
                const badgeClass = link.type === 'Parallel' ? 'badge-parallel' : 'badge-direct';
                const badgeLabel = link.type === 'Parallel' ? txt.parallel : txt.direct;
                
                // Use CSS var for size in links too
                const textStyle = STATE.lang === 'ar' 
                    ? 'font-family:var(--font-quran); font-size: calc(var(--quran-size) * 0.8); line-height:1.6; direction:rtl;' 
                    : 'font-size: calc(var(--trans-size) * 1.1); direction:ltr;';

                html += `
                <div class="link-card" onclick="jumpToVerse(${link.surah}, ${link.verse})">
                    <div class="link-header">
                        <span class="link-ref">${sName} ${link.surah}:${link.verse}</span>
                        <span class="badge ${badgeClass}">${badgeLabel}</span>
                    </div>
                    <div style="${textStyle}">${text}</div>
                </div>`;
            } catch(e) {}
        }
        container.innerHTML = html;
    }

    // --- SEARCH FUNCTIONALITY (Fixed) ---
    let searchTimeout;
    function debouncedSearch(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => doSearch(e.target.value), 600);
    }

    async function doSearch(query) {
        query = query.trim();
        const container = STATE.isMobile 
            ? document.getElementById('quran-container') // On mobile, replace main content? Or maybe a modal. For now, replace content.
            : document.getElementById('side-panel-content');

        const headerTitle = document.getElementById('panel-title');
        
        if(!query) {
            if(!STATE.isMobile) container.innerHTML = ''; 
            else loadSurah(STATE.currentSurah); // Restore surah on mobile if cleared
            return;
        }

        const txt = UI[STATE.lang];
        container.innerHTML = `<div class="loading">${txt.loading}</div>`;
        if(!STATE.isMobile) headerTitle.innerText = `${txt.search}: "${query}"`;

        try {
            // IMPORTANT: API needs 'keyword' search.
            // edition must match the language of the query.
            const edition = STATE.lang === 'ar' ? 'quran-uthmani' : 'en.sahih';
            
            const res = await fetch(`https://api.alquran.cloud/v1/search/${encodeURIComponent(query)}/all/${edition}`);
            const data = await res.json();

            if (data.status !== 'OK' || !data.data.matches || data.data.matches.length === 0) {
                container.innerHTML = `<div style="padding:20px; text-align:center;">${txt.noResults}</div>`;
                return;
            }

            let html = '';
            // Limit results to 20 for performance
            const matches = data.data.matches.slice(0, 30);
            
            html += `<div style="padding:10px; font-weight:bold; color:var(--primary)">Found ${data.data.count} results</div>`;

            matches.forEach(m => {
                const sName = STATE.lang === 'ar' ? m.surah.name : m.surah.englishName;
                const textStyle = STATE.lang === 'ar' 
                    ? 'font-family:var(--font-quran); font-size: 20px; direction:rtl;' 
                    : 'font-size: 14px; direction:ltr;';

                html += `
                <div class="link-card" onclick="jumpToVerse(${m.surah.number}, ${m.numberInSurah})">
                    <div class="link-header">
                        <span class="link-ref">${sName} ${m.surah.number}:${m.numberInSurah}</span>
                    </div>
                    <div style="${textStyle}">${m.text.replace(new RegExp(query, 'gi'), `<mark>${query}</mark>`)}</div>
                </div>`;
            });
            
            container.innerHTML = html;
            // On mobile, scroll top
            if(STATE.isMobile) document.getElementById('reader-panel').scrollTop = 0;

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="loading" style="color:red">Search Error. Try a different keyword.</div>`;
        }
    }

    // --- UTILS ---

    function jumpToVerse(surah, verse) {
        if (STATE.currentSurah === surah) {
            const el = document.getElementById(`verse-${surah}:${verse}`);
            if (el) {
                el.scrollIntoView({behavior: "smooth", block: "center"});
                activateVerse(`${surah}:${verse}`, true);
            }
        } else {
            loadSurah(surah, verse);
        }
    }

    function toggleTheme() {
        STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', STATE.theme);
        document.getElementById('theme-btn').innerText = STATE.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }

    function toggleLang() {
        STATE.lang = STATE.lang === 'ar' ? 'en' : 'ar';
        const isAr = STATE.lang === 'ar';
        document.documentElement.dir = isAr ? 'rtl' : 'ltr';
        updateUI();
        loadSurah(STATE.currentSurah); 
    }

    function changeFontSize(val) {
        document.documentElement.style.setProperty('--quran-size', val + 'px');
    }

    function changeSurah(val) {
        // Clear search input if changing surah manually
        document.getElementById('search-input').value = '';
        loadSurah(val);
    }

    function updateUI() {
        const t = UI[STATE.lang];
        document.getElementById('search-input').placeholder = t.search;
        document.getElementById('lang-btn').innerText = t.lang;
        document.getElementById('panel-title').innerText = t.refs;
        
        // Re-populate surah select to match language
        const sel = document.getElementById('surah-select');
        const currentVal = sel.value;
        populateSurahSelect();
        sel.value = currentVal;
    }

    function populateSurahSelect() {
        const sel = document.getElementById('surah-select');
        sel.innerHTML = '';
        for(let i=1; i<=114; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = STATE.lang === 'ar' ? `${i}. ÿ≥Ÿàÿ±ÿ©` : `${i}. Surah`;
            sel.appendChild(opt);
        }
    }
</script>
</body>
</html>